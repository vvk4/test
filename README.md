# Test ADC/UART/FreeRTOS

## Классы
Программа состоит из трех классов:
- AdcTest 
- UartTest
- LedTest

Все иницилизации во всех классах выполняются в конструкторе. Сами объекты классов определяются в соответствующих файлах. Поэтому в файле ```main.c``` вызовов функций классов или создания объектов не выполняется.

### AdcTest
По ТЗ максимальная частота входного сигнала 70Гц, поэтому АЦП настроен на частоту 200Гц. Для того, чтобы он мог работать на такой частоте, АЦП тактируется от таймера TIM3. Поэтому в этом классе выполняется инициализация как самого АЦП, так и таймера.
Также в конструкторе создается задача АЦП ``` ProcessADCTask ``` Эта задача может находится в двух состояниях: АЦП работает и АЦП выключен. В первом случае она все время заблокирована ожиданием появления в очереди измеренного значения. Во втором случае она проверяет флаг ```cpp ADC_WORK_ON``` в ``` xEventGroup```. Если этот флаг установлен, то включает АЦП и переходит в первое состояние.
При работающем АЦП и при появлении значения в очереди задача высчитывает среднее значение по AVRG_SIZE выборкам и записывает его и мгновенное значение в глобальную структуру
```cpp
struct ResultVal
{
  float instant_value;
  float average_value;
  float rms_value;
};
```
Значение RMS не вычислял из-за недостатка времени.

Далее из этой структуры данные могут быть переданы по UART
Также при работающем АЦП выполняется проверка флага ``` ADC_WORK_ON``` в ``` xEventGroup```. Если этот флаг сброшен, то АЦП выключается.


### UartTest
В конструкторе выполняется инициализация приема/передачи UART по DMA. Также в нем создается задача обработки принимаемых пакетов ```ProcessUARTRxTask```.
Передача выполняется функцией ``` UartTx```. В нее передается указатель на передаваемый массив и число передаваемых байт.
Прием также выполняется по DMA. Т.к. заранее число принимаемых байт неизвестно, то окончанием приема является событие IDLE порта uart. Это событие вызывает прерывание порта, в котором перезапускается DMA на прием для приема следующего пакета. 
Также в прерывании порта выдается семафор ```xSemaphoreGiveFromISR(xSemaphore, pdFALSE);``` для задачи обработки принимаемых пакетов. Эта задача все время находится блокированном состоянии в ожидании семафора. Когда приходит пакет, она вызывает функцию обработки ```ProcessUARTRxTask```. При команде "start" вызывается ```xEventGroupSetBits(xEventGroup, ADC_WORK_ON);```, при команде "stop" вызывается ```xEventGroupClearBits(xEventGroup, ADC_WORK_ON);```. Далее этот флаг проверяется в классе AdcTest. По команде "result" выполняется передача мгновенного и среднего значения в формате преобразованного значения ```float``` в строку:
```cpp
Instatnt: 2.570874V
Average: 2.573210V
```
Формат 4 1/2 не делал из-за недостатка времени.

Ошибочные команды выводятся в формате:
```cpp
unknown command: "fghdfgjdjfgdjfgj"
```

### LedTest
В задаче свотодиода проверяется флаг ```ADC_WORK_ON``` и при включенном АЦП светодиод горит постоянно, а при выключенном мигает с частотой 5Гц.

## Требует доработки
### Прием пакетов по DMA
Иногда при приеме пакета через DMA по событию IDLE возникает ошибки. При работе с терминала это проблемой не является, но для их устранения желательно выполнить прием через кольцевой буфер DMA.
### Частота контроллера.
Все частоты контроллера у меня снижены на 0.78% На работу это не влияет, но желательно с этим разобраться, т.к. причину быстро установить не удалось.

